mport sqlite3
import os
import datetime
from pathlib import Path


base_path = input('Определите корневой путь:')

if not os.path.exists(base_path):
    raise FileNotFoundError('Данного пути не существует.')

def get_item_info(base_path):

    return {
        'location' : os.path.abspath(base_path),
        'item_type' : 'file' if os.path.isfile(base_path) else 'directory',
        'depth' : os.path.abspath(base_path).count(os.sep),
        'date_of_creating' : datetime.datetime.fromtimestamp(os.path.getctime(base_path)).strftime('%d.%m.%Y'),
        'date_of_editing'  : datetime.datetime.fromtimestamp(os.path.getmtime(base_path)).strftime('%d.%m.%Y'),
        'size'  : os.path.getsize(base_path) if os.path.isfile(base_path) else None,
        'extension' : os.path.splitext(base_path)[1] if os.path.isfile(base_path) else None
    }

def get_data():
    result = []
    if os.path.isdir(base_path):
        for root, dirs, files in os.walk(base_path):
            info_fir = get_item_info(root)
            if info_fir:
                result.append(info_fir)
            for file in files:
                info_file = get_item_info(os.path.join(root, file))
                if info_file:
                    result.append(info_file)
    else: 
        info_single_item = get_item_info(base_path)
        if info_single_item:
            result.append(info_single_item)

    if result == []:
        raise ValueError("Не собрано данных для обработки.")
    
    return result

def is_changed(old_row, new_row):
    fields = ['item_type', 'depth', 'date_of_creating',
            'date_of_editing', 'size', 'extension']
    return any(old_row[field] != new_row[field] for field in fields)

def load_active_rows():
    cursor.execute("""
        SELECT location, item_type, depth, date_of_creating,
            date_of_editing, size, extension
        FROM data
        WHERE is_active = 1
    """)

    return {
        row[0]: {
            'item_type' : row[1],
            'depth' : row[2],
            'date_of_creating' : row[3],
            'date_of_editing' : row[4],
            'size' : row[5],
            'extension' : row[6]
        }
        for row in cursor.fetchall()
    }
    

now = datetime.datetime.now().strftime('%d.%m.%Y %H:%M:%S')

with sqlite3.connect('database.db') as db:
    cursor = db.cursor()

    cursor.execute("""
                CREATE TABLE IF NOT EXISTS data(
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                location TEXT NOT NULL,
                item_type TEXT,
                depth INTEGER,
                date_of_creating DATE,
                date_of_editing DATE,
                size INTEGER,
                extension TEXT,
                valid_from TIMESTAMP,
                valid_to TIMESTAMP,
                is_active INTEGER NOT NULL 
            )""")

    active_rows = load_active_rows()
    scanned_rows = get_data()

    updates = []
    inserts = []

    for row in scanned_rows:
        loc = row['location']
        old = active_rows.get(loc)

        if old is None:
            inserts.append((
                loc, row['item_type'], row['depth'], row['date_of_creating'],
                row['date_of_editing'], row['size'], row['extension'], now, None, 1
            ))
        elif is_changed(old, row):
            updates.append((now, loc))
            inserts.append((
                loc, row['item_type'], row['depth'], row['date_of_creating'],
                row['date_of_editing'], row['size'], row['extension'], now, None, 1
            ))

    deleted = [loc for loc in active_rows.keys() if loc not in {row['location'] for row in scanned_rows}]
    
    cursor.executemany("""
        UPDATE data
        SET valid_to = ?, is_active = 0
        WHERE location = ? AND is_active = 1
    """, [(now, loc) for loc in deleted])

    cursor.executemany("""
        UPDATE data
        SET valid_to = ?, is_active = 0
        WHERE location = ? AND is_active = 1
    """, updates)

    cursor.executemany("""
        INSERT INTO data(
            location, item_type, depth, date_of_creating, date_of_editing,
            size, extension, valid_from, valid_to, is_active
    ) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?) """, inserts)



